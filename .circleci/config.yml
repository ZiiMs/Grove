version: 2.1

orbs:
  github-cli: circleci/github-cli@2.3.0

commands:
  setup-rust:
    description: "Install Rust and restore cache"
    steps:
      - restore_cache:
          keys:
            - rust-{{ arch }}-{{ checksum "Cargo.lock" }}
            - rust-{{ arch }}-
      - run:
          name: Install Rust
          command: |
            if ! command -v rustup &> /dev/null; then
              curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
            fi
            echo 'source $HOME/.cargo/env' >> $BASH_ENV
      - save_cache:
          key: rust-{{ arch }}-{{ checksum "Cargo.lock" }}
          paths:
            - ~/.cargo/registry
            - ~/.cargo/git

jobs:
  build-linux:
    parameters:
      target:
        type: string
    machine:
      image: ubuntu-2204:current
    resource_class: large
    steps:
      - checkout
      - setup-rust
      - restore_cache:
          keys:
            - target-linux-{{ arch }}-{{ checksum "Cargo.lock" }}
            - target-linux-{{ arch }}-
      - run:
          name: Install cross
          command: cargo install cross --locked
      - run:
          name: Verify (clippy + test)
          command: cargo clippy --all-targets --all-features -- -D warnings && cargo test
      - run:
          name: Build
          command: cross build --release --locked --target << parameters.target >>
      - save_cache:
          key: target-linux-{{ arch }}-{{ checksum "Cargo.lock" }}
          paths:
            - target
      - run:
          name: Package
          command: |
            cd target/<< parameters.target >>/release
            tar -czvf ../../../grove-<< parameters.target >>.tar.gz grove
      - persist_to_workspace:
          root: .
          paths:
            - grove-*.tar.gz

  build-macos:
    parameters:
      target:
        type: string
    macos:
      xcode: 16.4.0
    resource_class: m4pro.medium
    steps:
      - checkout
      - setup-rust
      - restore_cache:
          keys:
            - target-macos-{{ arch }}-{{ checksum "Cargo.lock" }}
            - target-macos-{{ arch }}-
      - run:
          name: Add Rust target
          command: rustup target add << parameters.target >>
      - run:
          name: Verify (clippy + test)
          command: cargo clippy --all-targets --all-features -- -D warnings && cargo test
      - run:
          name: Build
          command: cargo build --release --locked --target << parameters.target >>
      - save_cache:
          key: target-macos-{{ arch }}-{{ checksum "Cargo.lock" }}
          paths:
            - target
      - run:
          name: Package
          command: |
            cd target/<< parameters.target >>/release
            tar -czvf ../../../grove-<< parameters.target >>.tar.gz grove
      - persist_to_workspace:
          root: .
          paths:
            - grove-*.tar.gz

  publish-release:
    docker:
      - image: cimg/base:stable
    steps:
      - attach_workspace:
          at: .
      - github-cli/setup
      - run:
          name: Upload release assets
          command: |
            for file in grove-*.tar.gz; do
              gh release upload $CIRCLE_TAG "$file" --clobber
            done

workflows:
  version: 2
  release:
    jobs:
      - build-linux:
          matrix:
            parameters:
              target:
                - x86_64-unknown-linux-musl
                - aarch64-unknown-linux-musl
          filters:
            tags:
              only: /^[a-f0-9]{7,40}$/
            branches:
              ignore: /.*/
      - build-macos:
          matrix:
            parameters:
              target:
                - x86_64-apple-darwin
                - aarch64-apple-darwin
          filters:
            tags:
              only: /^[a-f0-9]{7,40}$/
            branches:
              ignore: /.*/
      - publish-release:
          requires:
            - build-linux
            - build-macos
          filters:
            tags:
              only: /^[a-f0-9]{7,40}$/
            branches:
              ignore: /.*/
